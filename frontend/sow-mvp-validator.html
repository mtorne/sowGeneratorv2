<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SoW MVP Validator</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f6f9; color: #1f2937; }
    .container { max-width: 960px; margin: 24px auto; background: #fff; border-radius: 12px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); padding: 24px; }
    h1 { margin-top: 0; font-size: 1.5rem; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .field { margin-bottom: 12px; }
    label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 0.9rem; }
    input, textarea, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 0.95rem; box-sizing: border-box; }
    textarea { min-height: 90px; resize: vertical; }
    .actions { display: flex; gap: 10px; margin-top: 8px; flex-wrap: wrap; }
    button { border: 0; border-radius: 8px; padding: 10px 14px; background: #2563eb; color: white; cursor: pointer; font-weight: 600; }
    button.secondary { background: #475569; }
    button:disabled { background: #94a3b8; cursor: not-allowed; }
    .status { margin-top: 16px; padding: 10px; border-radius: 8px; background: #eff6ff; border: 1px solid #bfdbfe; font-size: 0.9rem; white-space: pre-wrap; }
    .output { margin-top: 16px; padding: 12px; border-radius: 8px; background: #0f172a; color: #e2e8f0; white-space: pre-wrap; min-height: 60px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
    .hint { color: #64748b; font-size: 0.88rem; margin-top: 6px; }
    .file-meta { color: #475569; font-size: 0.85rem; margin-top: 6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>SoW MVP Validator UI</h1>
    <p class="hint">Uses relative API context for proxy deployments such as <code>/composer/rag-chat.html</code>.</p>

    <div class="field">
      <label for="apiContext">API Context Prefix</label>
      <input id="apiContext" value="/composer" />
      <p class="hint">Examples: <code>/composer</code> or empty for root deployment.</p>
    </div>

    <div class="actions">
      <button type="button" id="healthBtn">Check Health</button>
      <button type="button" class="secondary" id="sampleBtn">Load Sample</button>
    </div>

    <hr />

    <div class="row">
      <div class="field"><label for="client">Client</label><input id="client" value="Cegid" /></div>
      <div class="field"><label for="project_name">Project Name</label><input id="project_name" value="xrp Modernization" /></div>
      <div class="field"><label for="cloud">Cloud</label><input id="cloud" value="OCI" /></div>
      <div class="field"><label for="duration">Duration</label><input id="duration" value="4 months" /></div>
    </div>

    <div class="field">
      <label for="scope">Scope</label>
      <textarea id="scope">Refactor monolith to microservices</textarea>
    </div>

    <div class="row">
      <div class="field">
        <label for="currentArchitectureImage">Current Architecture Diagram (optional)</label>
        <input id="currentArchitectureImage" type="file" accept="image/*" />
        <div id="currentArchitectureImageMeta" class="file-meta">No file selected.</div>
      </div>
      <div class="field">
        <label for="targetArchitectureImage">Target Architecture Diagram (optional)</label>
        <input id="targetArchitectureImage" type="file" accept="image/*" />
        <div id="targetArchitectureImageMeta" class="file-meta">No file selected.</div>
      </div>
    </div>

    <div class="actions">
      <button type="button" id="generateBtn">Generate SoW</button>
      <select id="downloadType">
        <option value="docx">DOCX</option>
        <option value="md">Markdown</option>
      </select>
      <button type="button" class="secondary" id="downloadBtn" disabled>Download Generated File</button>
    </div>

    <div id="status" class="status">Ready.</div>
    <div id="output" class="output">No response yet.</div>
  </div>

  <script>
    const statusEl = document.getElementById('status');
    const outputEl = document.getElementById('output');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadType = document.getElementById('downloadType');
    const currentArchitectureImage = document.getElementById('currentArchitectureImage');
    const targetArchitectureImage = document.getElementById('targetArchitectureImage');
    const currentArchitectureImageMeta = document.getElementById('currentArchitectureImageMeta');
    const targetArchitectureImageMeta = document.getElementById('targetArchitectureImageMeta');
    let lastGenerated = null;

    function normalizeContext(raw) {
      const value = (raw || '').trim();
      if (!value) {
        return '';
      }
      const withSlash = value.startsWith('/') ? value : `/${value}`;
      return withSlash.replace(/\/$/, '');
    }

    function getPath(path) {
      const context = normalizeContext(document.getElementById('apiContext').value);
      return `${context}${path}`;
    }

    function setStatus(message, isError = false) {
      statusEl.textContent = message;
      statusEl.style.background = isError ? '#fef2f2' : '#eff6ff';
      statusEl.style.borderColor = isError ? '#fecaca' : '#bfdbfe';
    }

    function getPayload() {
      return {
        client: document.getElementById('client').value,
        project_name: document.getElementById('project_name').value,
        cloud: document.getElementById('cloud').value,
        scope: document.getElementById('scope').value,
        duration: document.getElementById('duration').value
      };
    }

    function updateDownloadButtonState() {
      downloadBtn.disabled = !lastGenerated;
    }

    function downloadTextFile(content, filename, mimeType = 'text/plain;charset=utf-8') {
      const blob = new Blob([content], { type: mimeType });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      link.remove();
      URL.revokeObjectURL(url);
    }

    function updateFileMeta(inputEl, metaEl) {
      const file = inputEl.files && inputEl.files[0];
      if (!file) {
        metaEl.textContent = 'No file selected.';
        return;
      }
      const kb = Math.max(1, Math.round(file.size / 1024));
      metaEl.textContent = `${file.name} (${kb} KB)`;
    }

    currentArchitectureImage.addEventListener('change', () => updateFileMeta(currentArchitectureImage, currentArchitectureImageMeta));
    targetArchitectureImage.addEventListener('change', () => updateFileMeta(targetArchitectureImage, targetArchitectureImageMeta));

    document.getElementById('sampleBtn').addEventListener('click', () => {
      document.getElementById('client').value = 'Cegid';
      document.getElementById('project_name').value = 'xrp Modernization';
      document.getElementById('cloud').value = 'OCI';
      document.getElementById('scope').value = 'Refactor monolith to microservices';
      document.getElementById('duration').value = '4 months';
      setStatus('Sample payload loaded.');
    });

    document.getElementById('healthBtn').addEventListener('click', async () => {
      const path = getPath('/');
      setStatus(`Calling ${path} ...`);
      try {
        const response = await fetch(path);
        const body = await response.json();
        outputEl.textContent = JSON.stringify(body, null, 2);
        setStatus(`Health check success: HTTP ${response.status}`);
      } catch (error) {
        setStatus(`Health check failed: ${error.message}`, true);
      }
    });

    document.getElementById('generateBtn').addEventListener('click', async () => {
      const path = getPath('/generate-sow');
      const payload = getPayload();
      const formData = new FormData();
      formData.append('project_data', JSON.stringify(payload));

      const currentFile = currentArchitectureImage.files && currentArchitectureImage.files[0];
      const targetFile = targetArchitectureImage.files && targetArchitectureImage.files[0];
      if (currentFile) {
        formData.append('current_architecture_image', currentFile, currentFile.name);
      }
      if (targetFile) {
        formData.append('target_architecture_image', targetFile, targetFile.name);
      }

      setStatus(`Posting multipart request to ${path} ...`);
      try {
        const response = await fetch(path, {
          method: 'POST',
          body: formData
        });
        const body = await response.json();
        outputEl.textContent = JSON.stringify(body, null, 2);
        if (!response.ok) {
          setStatus(`Generate failed: HTTP ${response.status}`, true);
          lastGenerated = null;
          updateDownloadButtonState();
          return;
        }
        lastGenerated = body;
        updateDownloadButtonState();
        setStatus('Generate success. Sections generated in JSON response.');
      } catch (error) {
        setStatus(`Generate failed: ${error.message}`, true);
      }
    });

    downloadBtn.addEventListener('click', () => {
      if (!lastGenerated) {
        setStatus('Nothing to download yet. Generate a SoW first.', true);
        return;
      }
      const selectedType = downloadType.value;

      if (selectedType === 'md' && typeof lastGenerated.document_markdown === 'string' && lastGenerated.document_markdown.trim()) {
        const safeClient = (document.getElementById('client').value || 'sow').trim().replace(/\s+/g, '_');
        const generatedName = `${safeClient}_sow.md`;
        downloadTextFile(lastGenerated.document_markdown, generatedName, 'text/markdown;charset=utf-8');
        setStatus(`Downloaded markdown from in-memory response as ${generatedName}.`);
        return;
      }

      const fileName = selectedType === 'md' ? lastGenerated.markdown_file : lastGenerated.file;
      if (!fileName) {
        setStatus(`No ${selectedType.toUpperCase()} file available in last response. Server did not return a downloadable file path.`, true);
        return;
      }
      const path = getPath(`/files/${encodeURIComponent(fileName)}`);
      setStatus(`Downloading ${fileName} ...`);
      window.open(path, '_blank');
    });

    updateDownloadButtonState();
  </script>
</body>
</html>
